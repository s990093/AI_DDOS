\documentclass[tikz, border=10pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{shapes.geometric, arrows.meta, positioning, fit, calc, backgrounds, shadows, shapes.arrows, shapes.misc}
\usepackage{amsmath, amssymb}

% Colors Definition matching the original image closely
\definecolor{headerblue}{RGB}{180, 210, 255}
\definecolor{containerblue}{RGB}{210, 230, 255}
\definecolor{innerblue}{RGB}{225, 240, 255}
\definecolor{arrowpurple}{RGB}{200, 130, 220}

\definecolor{headergreen}{RGB}{160, 220, 130}
\definecolor{containergreen}{RGB}{200, 240, 180}
\definecolor{darkgreentitle}{RGB}{80, 150, 60}
\definecolor{darkgreen}{RGB}{100, 180, 80} % Restored missing color
\definecolor{innergreen}{RGB}{180, 220, 150}
\definecolor{emgreen}{RGB}{210, 235, 190}

\definecolor{myorange}{RGB}{255, 200, 140}
\definecolor{mypink}{RGB}{255, 170, 180}
\definecolor{mydarkpink}{RGB}{220, 100, 120}
\definecolor{myviolet}{RGB}{190, 150, 240}
\definecolor{mambacyan}{RGB}{180, 230, 240}

\begin{document}
\begin{tikzpicture}[
    font=\sffamily,
    >=Latex,
    node distance=0.5cm,
    % General Styles
    mainarrow/.style={->, line width=3pt, draw=black},
    thickarrow/.style={->, line width=2pt},
    basebox/.style={draw=black, line width=0.8pt, rounded corners, align=center, font=\small},
    % Input Style
    inputbox/.style={fill=headerblue!50, draw=none, minimum height=0.8cm, text width=12cm, align=center, font=\bfseries\small, rounded corners},
    % Containers & Headers
    bluecontainer/.style={fill=containerblue, draw=blue!40!black, line width=1pt, rounded corners, inner sep=0pt},
    greencontainer/.style={fill=containergreen, draw=darkgreen, line width=1pt, rounded corners, inner sep=0pt},
    containerheader/.style={font=\bfseries\large, align=center, minimum height=1cm},
    % Inner Boxes Styles
    process/.style={basebox, fill=white, minimum height=0.7cm},
    innerbluebox/.style={basebox, fill=innerblue, draw=blue!40},
    darkgreentitlebox/.style={fill=darkgreentitle, text=white, font=\bfseries\small, align=center, rounded corners, minimum height=0.7cm},
    innergreenbox/.style={basebox, fill=innergreen, draw=darkgreentitle},
    orangebox/.style={basebox, fill=myorange, draw=orange!80!black},
    pinkbox/.style={basebox, fill=mypink, draw=mydarkpink, rounded corners=5pt},
    violetbox/.style={basebox, fill=myviolet, draw=violet!80!black, text=white},
    mambabox/.style={basebox, fill=mambacyan, draw=black},
    % Mamba Detail Styles
    proj trap/.style={trapezium, draw=darkgreentitle, fill=innergreen, trapezium left angle=70, trapezium right angle=70, minimum width=1.2cm, font=\scriptsize},
    silu circle/.style={circle, fill=mypink, inner sep=1pt, font=\small}
    ]

    % =========================================================
    % 1. TOP: Network Traffic Input
    % =========================================================
    \node[inputbox] (input) {Network Traffic Input (Protocol, Flow Duration, Flow Bytes/s, Total Packets, $\cdots$)};
    
    % Main arrow down
    \draw[mainarrow] ($(input.south)+(0,-0.2)$) -- ++(0,-1);

    % =========================================================
    % 2. Feature Engineering Module (Blue Container)
    % =========================================================
    \node[below=1.4cm of input, minimum width=13cm, minimum height=3.5cm] (fe_center) {};
    
    % Container Background
    \begin{scope}[on background layer]
        \node[bluecontainer, fit={(fe_center)}] (fe_box) {};
    \end{scope}
    
    % Header Text
    \node[above=0.1cm of fe_box.north, anchor=south, font=\bfseries\large] {Feature Engineering and Selection Module};
    
    % Left Content: Entropy
    \node[innerbluebox, minimum width=5.5cm, minimum height=2.5cm, left=0.5cm of fe_center] (entropy_container) {};
    \node[below right=0.1cm of entropy_container.north west, font=\bfseries\small] {Multi-Entropy Computation};
    
    \node[process, minimum width=1.3cm, below=0.8cm of entropy_container.north, xshift=-1.8cm] (shannon) {Shannon};
    \node[process, minimum width=1.3cm, right=0.3cm of shannon] (renyi) {Rényi};
    \node[process, minimum width=1.3cm, right=0.3cm of renyi] (min) {Min};
    
    % Right Content: Formula
    \node[innerbluebox, minimum width=5.5cm, minimum height=2.5cm, right=0.5cm of fe_center] (formula_container) {};
    \node[align=center] at (formula_container.center) {
        {\Huge $H(X \mid \text{ddos})$} \\[0.8em]
        \textbf{\small Select top 10\% of features with \\ lowest conditional entropy}
    };
    
    % Purple connecting arrow
    \node[single arrow, fill=arrowpurple, minimum height=1.2cm, minimum width=1.2cm] at (fe_center) {};

    % Main arrow down to Stage 1
    \draw[mainarrow] ($(fe_box.south)+(0,-0.2)$) -- ++(0,-1);

    % =========================================================
    % 3. Stage 1: PSO-GMM (Green Container) - 左側
    % =========================================================
    \node[below=1.5cm of fe_box, minimum width=13cm, minimum height=7cm] (st1_center) {};

    % Container Background & Header
    \begin{scope}[on background layer]
        \node[greencontainer, fit={(st1_center)}] (st1_box) {};
        % Header Bar
        \fill[headergreen, rounded corners] (st1_box.north west) rectangle ($(st1_box.north east) + (0, -1)$);
        \node[containerheader] at ($(st1_box.north)!0.5!(st1_box.north east) + (-6.5, -0.5)$) {Stage 1: PSO-GMM Anomalous Traffic Clustering Module};
    \end{scope}

    % --- Layout inside Stage 1 ---
    \coordinate (st1_content_top) at ($(st1_box.north) + (0, -1.2)$);

    % Left Sub-module: GMM Initialization
    \node[innergreenbox, minimum width=6cm, minimum height=4cm, below left=0cm and 0.2cm of st1_content_top, anchor=north] (gmm_box) {};
    
    % Title bar for GMM
    \node[darkgreentitlebox, minimum width=5.8cm, below=0.1cm of gmm_box.north] (gmm_title) {GMM Initialization Optimization \\ Module (PSO-based)};
    
    % EM Algorithm Box inside GMM
    \node[basebox, fill=emgreen, minimum width=5cm, minimum height=2.2cm, below=0.3cm of gmm_title] (em_box) {};
    \node[below=0.1cm of em_box.north, font=\bfseries\scriptsize] {EM algorithm iteration};
    \node[process, fill=white, minimum width=4.5cm, below=0.4cm of em_box.north] (estep) {E-Step $\mid \to \mathbf{\gamma}$};
    \node[process, fill=white, minimum width=4.5cm, below=0.2cm of estep] (mstep) {M-Step $\mid \to \{ \mathbf{\mu}, \mathbf{\Sigma}, \mathbf{\pi} \}$};

    % Iteration Cycle Arrows
    \draw[thickarrow, bend left=45] ($(em_box.east)+(0.1, 0.4)$) to node[right, font=\scriptsize] {Iteration} ($(em_box.east)+(0.1, -0.4)$);
    \draw[thickarrow, bend left=45] ($(em_box.east)+(0.1, -0.4)$) to ($(em_box.east)+(0.1, 0.4)$);

    % Convergence Text
    \node[below=0.1cm of em_box, align=center, font=\scriptsize] {Convergence check (Log-\\Likelihood) and output $\theta^*$};

    % Right Sub-module: Objective Function
    \node[innergreenbox, minimum width=6cm, minimum height=3cm, below right=0cm and 0.2cm of st1_content_top, anchor=north] (obj_box) {};
    \node[darkgreentitlebox, minimum width=5.8cm, below=0.1cm of obj_box.north] (obj_title) {Objective Function};
    \node[below=0.2cm of obj_title] {
        \resizebox{5.2cm}{!}{
        $F(\mathbf{w}) =
        \begin{cases}
        \min\limits_{k \in K} \left[ -w_{\text{ddos}} \frac{d_k}{N} + w_{\text{benign}} \frac{b_k}{d_k + b_k} \right], & \text{if } \exists k \in K : \frac{d_k}{d_k + b_k} \ge \theta \\
        \lambda_{\text{penalty}}, & \text{otherwise}.
        \end{cases}$
        }
    };

    % Bottom Sub-module: Classification (Orange)
    \node[orangebox, minimum width=6.5cm, minimum height=2cm, below=4.5cm of st1_content_top, xshift=3cm] (class_box) {
        \textbf{\hspace{1em}Output cluster classification:} \\[0.5em]
        \hspace{1em}1. $\ge \theta \to$ cddos (high-purity DDoS) \\
        \hspace{1em}2. $< \theta \to$ cmixed (passed to stage 2 \\ \hspace{3em} for further analysis)
    };

    % Green Arrow connecting GMM to Classification
    \draw[->, line width=4pt, draw=darkgreentitle] (gmm_box.south) -- ++(0,-0.5) -| ($(class_box.west)+(0.5,0)$);

    % =========================================================
    % 4. Global Connection (Stage 1 to Stage 2)
    % =========================================================
    \node[right=1.5cm of st1_box] (st2_placeholder) {};
    \draw[mainarrow] (st1_box.east) -- node[below=0.3cm, font=\bfseries\large] {cmixed} (st2_placeholder);

    % =========================================================
    % 5. Stage 2: Deep Analysis (Right Side)
    % =========================================================
    % Container
    \node[greencontainer, right=2cm of st1_box.north east, anchor=north west, minimum width=11cm, minimum height=12cm] (st2_box) {};
    % Header Bar
    \fill[headergreen, rounded corners] (st2_box.north west) rectangle ($(st2_box.north east) + (0, -1)$);
    \node[containerheader] at ($(st2_box.north)!0.5!(st2_box.north east) + (-5.5, -0.5)$) {Stage-2 : Deep Analysis};
    
    \coordinate (st2_content_top) at ($(st2_box.north west) + (2.5cm, -2cm)$);

    % Left Column: The Stack
    \node[above=0.2cm of st2_content_top, font=\small, draw, dashed, inner sep=3pt] (input_dim) {$cmixed[B, T, Din]$};
    
    \node[pinkbox, minimum width=3cm, below=0.5cm of input_dim] (lin1) {Linear+\\LayerNorm+Dropout};
    \node[pinkbox, minimum width=3cm, below=0.3cm of lin1] (posenc) {Positional Encoding};
    
    % Mamba Stack effect
    \node[mambabox, minimum width=3cm, minimum height=1.2cm, below=0.3cm of posenc] (mamba_stack_bg) {};
    \foreach \i in {1,2,3} { \node[mambabox, minimum width=3cm, minimum height=1cm] at ($(mamba_stack_bg.center) + (\i*2pt, \i*2pt)$) {}; }
    \node[mambabox, minimum width=3cm, minimum height=1cm, below=0.3cm of posenc] (mamba_block) {Mamba block};
    \node[left=0.1cm of mamba_block, font=\small] {x4};
    
    \node[violetbox, minimum width=3cm, below=0.3cm of mamba_stack_bg] (pool) {Mean Pooling};
    \node[darkgreentitlebox, minimum width=3cm, below=0.3cm of pool] (ffn) {FFN};
    \node[pinkbox, minimum width=3cm, below=0.3cm of ffn] (lin2) {LayerNorm+Dropout};
    \node[orangebox, rounded corners=10pt, minimum width=3cm, below=0.3cm of lin2] (sigmoid) {Linear $\to$ Sigmoid};

    % Stack Arrows
    \draw[thickarrow] (input_dim) -- (lin1);
    \draw[thickarrow] (lin1) -- (posenc);
    \draw[thickarrow] (posenc) -- (mamba_block);
    \draw[thickarrow] (mamba_stack_bg) -- (pool);
    \draw[thickarrow] (pool) -- (ffn);
    \draw[thickarrow] (ffn) -- (lin2);
    \draw[thickarrow] (lin2) -- (sigmoid);

    % Right Column: Mamba Detail View
    \coordinate (detail_top) at ($(st2_box.north east) + (-3cm, -2.5cm)$);
    \node[font=\bfseries\large, right=1cm of mamba_block] (mamba_title) {Mamba};
    
    % Input Array
    \coordinate (d_in_start) at ($(mamba_title.south) + (-1, -0.5)$);
    \foreach \x in {0,1,...,7} \fill[mambacyan!80!blue] ($(d_in_start) + (\x*0.25, 0)$) rectangle ++(0.2, 0.25);
    \coordinate (d_in_center) at ($(d_in_start) + (4*0.25, 0)$);
    \node[below=0.3cm of d_in_start, xshift=1cm, font=\scriptsize] {Input};
    
    % Split & Branches
    \coordinate (split) at ($(d_in_center) + (0, -0.8)$);
    \draw[thick] ($(d_in_center)+(0, 0.1)$) -- (split);
    
    % Left Branch
    \node[proj trap, below left=0.5cm and 0.2cm of split] (proj1) {Projection};
    \node[mambabox, below=0.3cm of proj1, minimum width=1.2cm, font=\scriptsize] (conv) {Conv};
    \node[silu circle, below=0.3cm of conv] (silu1) {$\sigma$}; \node[right=0cm of silu1, font=\tiny] {SiLU};
    \node[basebox, fill=innerblue, below=0.3cm of silu1, minimum width=1.2cm, font=\scriptsize] (ssm) {SSM};
    
    % Right Branch
    \node[proj trap, below right=0.5cm and 0.2cm of split] (proj2) {Projection};
    \node[silu circle] (silu2) at (silu1 -| proj2) {$\sigma$}; \node[right=0cm of silu2, font=\tiny] {SiLU};
    
    % Connections
    \draw[thick] (split) -| (proj1);
    \draw[thick] (split) -| (proj2);
    \draw[thick] (proj1) -- (conv);
    \draw[thick] (conv) -- (silu1);
    \draw[thick] (silu1) -- (ssm);
    \draw[thick] (proj2) -- (silu2);
    
    % Multiply
    \node[circle, draw, cross out, inner sep=2pt, minimum size=0.4cm, below=0.3cm of ssm] (mult) {};
    \draw[thick] (ssm) -- (mult);
    \draw[thick] (silu2) |- (mult);
    
    % Final Proj
    \node[proj trap, below=0.3cm of mult] (proj_final) {Projection};
    \draw[thick] (mult) -- (proj_final);
    
    % Output Array
    \coordinate (d_out_start) at ($(proj_final.south) + (-1, -0.5)$);
    \foreach \x in {0,1,...,7} \fill[mypink] ($(d_out_start) + (\x*0.25, 0)$) rectangle ++(0.2, 0.25);
    \coordinate (d_out_center) at ($(d_out_start) + (4*0.25, 0)$);
    \node[above=0.3cm of d_out_start, xshift=1cm, font=\scriptsize] {Output};
    \draw[thick] (proj_final) -- ($(d_out_center)+(0, 0.25)$);

    % Dashed Zoom Arrows (Corrected Colors and Curve)
    \draw[dashed, line width=1.5pt, mambacyan!80!blue, ->] (mamba_block.east) to[out=0, in=180] ($(d_in_start)+(-0.2,0.125)$);
    \draw[dashed, line width=1.5pt, mypink, ->] ($(d_out_start)+(-0.2, 0.125)$) to[out=180, in=0] (lin2.east);

    % Final Output Text and Arrow
    \node[right=0.3cm of sigmoid, font=\small] (final_txt) {Output [B, 1]};
    \draw[mainarrow] (final_txt.east) -- ++(1,0);
    \node[right=1.5cm of final_txt, font=\bfseries\large] {Block or Pass};

\end{tikzpicture}
\end{document}