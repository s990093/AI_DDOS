# PSO-KMeans 聚類演算法訓練流程

## 概述

此程式實現了一個結合粒子群優化 (PSO) 和 K-means 的混合聚類演算法。通過 PSO 來優化 K-means 的初始中心點位置，以獲得更好的聚類結果。

## 命令列參數

- `--cpu, -c`: 使用的 CPU 核心數（預設：-1，表示使用所有核心）
- `--iterations, -i`: PSO 最大迭代次數（預設：300）
- `--population, -p`: PSO 粒子群體大小（預設：40）
- `--min-clusters, -min`: 最小聚類數（預設：2）
- `--max-clusters, -max`: 最大聚類數（預設：10）
- `--pca-components, -d`: PCA 降維維度（預設：0，表示不降維）
- `--k, -k`: 指定單一 k 值進行聚類（預設：None）
- `--sample-size, -s`: 用於聚類的樣本數量（預設：2000）

## 執行流程

### 1. 數據預處理

- 載入並預處理原始數據
- 進行特徵縮放
- 可選：執行 PCA 降維
  - 顯示累積解釋方差比例
  - 根據指定維度進行降維
- 對數據進行採樣以提高效率

### 2. 聚類優化過程

對每個可能的 k 值（或指定的單一 k 值）：

1. **PSO 初始化**

   - 設置粒子維度（k \* 特徵數）
   - 配置 PSO 參數（c1, c2, w, k, p）
   - 設置搜索邊界

2. **PSO 優化過程**

   - 動態調整慣性權重
   - 使用多進程並行評估粒子適應度
   - 評估指標包括：
     - Silhouette Score（輪廓係數）
     - Calinski-Harabasz Score（CH 分數）
     - Davies-Bouldin Score（DB 分數）

3. **最終評估**
   - 使用 PSO 找到的最佳中心點進行 K-means 聚類
   - 計算最終的評估指標
   - 更新全局最佳結果

### 3. 結果處理

- 輸出最佳的 k 值和對應的評估指標
- 保存模型：
  - 最佳中心點
  - PCA 模型（如果使用）
  - 聚類數量
  - 評估指標

### 4. 視覺化

- 使用 PCA 將數據降至 3 維
- 繪製 3D 散點圖：
  - 顯示聚類結果
  - 標記中心點位置
- 保存視覺化結果

## 評估指標說明

1. **Silhouette Score（-1 到 1）**

   - 衡量聚類的緊密度和分離度
   - 越接近 1 表示聚類效果越好

2. **Calinski-Harabasz Score（≥0）**

   - 衡量聚類的密集度和分離度
   - 數值越大表示聚類效果越好

3. **Davies-Bouldin Score（≥0）**
   - 衡量聚類的緊密度和分離度
   - 數值越小表示聚類效果越好


## 目標函數計算流程

### 1. 目標函數結構

目標函數（objective_function）用於評估每個粒子的適應度，結合了三個主要的聚類評估指標：

### 2. 計算步驟

1. **距離和標籤計算** (@jit 加速)

   - 輸入：數據矩陣和粒子位置（聚類中心）
   - 計算步驟：
     1. 計算每個數據點到每個聚類中心的歐氏距離
     2. 為每個數據點分配最近的聚類標籤
   - 輸出：距離矩陣和標籤矩陣

2. **評估指標計算**

   - 使用 scikit-learn 提供的三個評估指標：
     1. Silhouette Score (輪廓係數)
     2. Calinski-Harabasz Score (CH 分數)
     3. Davies-Bouldin Score (DB 分數)

3. **綜合得分計算**
   ```python
   score = (-silhouette * 0.4 +        # 輪廓係數（越大越好，所以加負號）
            -calinski/10000 * 0.3 +    # CH分數（越大越好，所以加負號）
            davies * 0.3)              # DB分數（越小越好）
   ```

### 3. 優化技術

1. **並行處理**

   - 使用 ProcessPoolExecutor 進行多進程計算
   - 每個進程獨立計算一個粒子的評估指標

2. **記憶體優化**

   - 使用共享記憶體（SharedMemory）存儲數據
   - 避免大量數據在進程間複製

3. **計算加速**
   - 使用 Numba @jit 裝飾器加速距離計算
   - 使用並行循環 prange 優化計算效能

### 4. 特殊處理

1. **無效聚類處理**

   - 檢查每個粒子的唯一標籤數
   - 排除聚類數不符合要求的粒子
   - 對無效粒子賦予極大的懲罰值（1e6）

2. **異常處理**
   - 捕獲評估指標計算中的異常
   - 確保程式穩定運行

### 5. 評分權重說明

- Silhouette Score: 40% 權重

  - 範圍：[-1, 1]
  - 越大越好

- Calinski-Harabasz Score: 30% 權重

  - 範圍：[0, ∞)
  - 越大越好
  - 除以 10000 進行標準化 超過用logp1計算

- Davies-Bouldin Score: 30% 權重
  - 範圍：[0, ∞)
  - 越小越好

最終得分越小表示聚類效果越好。這種加權方式平衡了不同評估指標的重要性，並統一了優化方向（最小化）。
